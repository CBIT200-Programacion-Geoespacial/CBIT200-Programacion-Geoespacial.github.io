{"title":"Modelos con rasters","markdown":{"yaml":{"title":"Modelos con rasters","author":"Derek Corcoran","date":"`r format(Sys.time(), '%d/%m, %Y')`","output":{"ioslides_presentation":{"widescreen":true,"incremental":true}}},"headingText":"Estudio de abundancia","containsRefs":false,"markdown":"\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, cache = FALSE, tidy = TRUE, tidy.opts= list(blank = FALSE, width.cutoff = 60))\nlibrary(leaflet)\nlibrary(sf)\nlibrary(tidyverse)\nlibrary(rgdal)\nlibrary(raster)\nlibrary(rasterVis)\nlibrary(rworldxtra)\nlibrary(tidyverse)\nlibrary(gridExtra)\nlibrary(kableExtra)\noptions(\"kableExtra.html.bsTable\" = T)\n```\n\n\n```{r, echo = TRUE, eval=TRUE}\nlibrary(rworldxtra)\nlibrary(raster)\nlibrary(sf)\nlibrary(tidyverse)\n```\n\nDatos son parte de [PREDICTS](https://onlinelibrary.wiley.com/doi/full/10.1002/ece3.2579)\n\n```{r}\ndata(\"countriesHigh\")\nDatos <- read_csv(\"https://raw.githubusercontent.com/derek-corcoran-barrios/derek-corcoran-barrios.github.io/master/Presentaciones_Espacial/Bombus.csv\")\n\n## Miremos los datos\n\nDatos <- Datos %>% st_as_sf(coords = c(5,6), crs = \"+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0\")\n\nMapa <- countriesHigh %>% st_as_sf() %>% st_crop(Datos)\n```\n\n```{r, eval=F}\nwrite_sf(Datos, \"Datos.shp\")\n```\n\n## Vamos graficando\n\n```{r}\nggplot() + geom_sf(data = Mapa) + theme_bw()\n```\n\n## Agreguemos los puntos\n\n```{r}\nggplot() + geom_sf(data = Mapa) + geom_sf(data =  Datos) + theme_bw()\n```\n\n## Agreguemos colores por especie\n\n```{r}\nggplot() + geom_sf(data = Mapa) + geom_sf(data =  Datos, aes(color = species)) + theme_bw()\n```\n\n## Agreguemos el tamaño por abundancia\n\n```{r}\nggplot() + geom_sf(data = Mapa) + geom_sf(data =  Datos, aes(color = species, size = Measurement)) + theme_bw()\n```\n\n## o un panel por especie\n\n```{r}\nggplot() + geom_sf(data = Mapa) + geom_sf(data =  Datos, aes(size = Measurement)) + theme_bw() + facet_wrap(~species)\n```\n\n## Resumen\n\n-   Ver video [tidyverse](https://youtu.be/5tjCeFb2oSk)\n\n```{r, echo = FALSE}\nDatos %>% as.data.frame() %>% group_by(species) %>% summarise(n = n(), mean = mean(Measurement), max = max(Measurement), min = min(Measurement)) %>% arrange(desc(mean)) %>% kable() %>% kable_styling(bootstrap_options = c(\"striped\", \"hover\", \"condensed\")) %>%\n  scroll_box(width = \"100%\", height = \"400px\")\n```\n\n# Ahora a modelar\n\n## Modelemos abundancia de Bombus impatiens\n\n```{r}\nB_impatiens <- Datos %>%  dplyr::filter(species == \"Bombus impatiens\")\n\nggplot() + geom_sf(data = Mapa) + geom_sf(data =  B_impatiens, aes(size = Measurement)) + theme_bw()\n```\n\n## Obtengamos datos climaticos\n\n```{r}\nBioclim <- getData(\"worldclim\", var = \"bio\", res = 2.5) %>% crop(B_impatiens)\nplot(Bioclim)\n```\n\n## Que es esto?\n\n[Worlclim capas bioclimáticas](https://www.worldclim.org/data/bioclim.html)\n\n```{r}\nBioclim <- Bioclim[[c(1,7,12,15)]]\nplot(Bioclim)\n```\n\n# Ahora juntemos las bases de datos\n\n## Extracción de datos en los puntos\n\n```{r}\nClima <- raster::extract(Bioclim, B_impatiens) %>% as.data.frame()\n```\n\n```{r, echo = FALSE}\nkable(Clima) %>% kable_styling(bootstrap_options = c(\"striped\", \"hover\", \"condensed\")) %>%  scroll_box(width = \"100%\", height = \"400px\")\n```\n\n## Juntamos con abundancia\n\n```{r}\nB_impatiens <- B_impatiens %>% bind_cols(Clima)\n```\n\n## Veamos relaciones\n\n```{r,echo=FALSE}\nFor_Plot <- B_impatiens %>% pivot_longer(cols = bio1:bio15, names_to = \"Variable\") %>% mutate(Variable = fct_relevel(Variable, \"bio1\", \"bio7\", \"bio12\"))\n\nggplot(For_Plot, aes(x = value, y = Measurement)) + geom_point()  + facet_wrap(~Variable, scales = \"free_x\") + theme_bw()\n```\n\n# A modelar\n\n## LM\n\n```{r}\nFitLM <- lm(Measurement ~ bio1 + I(bio1^2) + bio7 + I(bio7^2) + bio12 + I(bio12^2) + bio15+ I(bio15^2), data = B_impatiens)\n```\n\n```{r, echo = FALSE}\nbroom::tidy(FitLM) %>%  kable() %>% kable_styling(bootstrap_options = c(\"striped\", \"hover\", \"condensed\")) %>%  scroll_box(width = \"100%\", height = \"400px\")\n```\n\n## Predecir en un raster\n\n```{r}\nPrediccion <- predict(Bioclim, FitLM)\nplot(Prediccion, colNA = \"black\")\n```\n\n-   Que porblema hay acá?\n\n# GLM\n\n## GLM\n\n-   Para mas información ver [este video](https://youtu.be/1gLswJR7ZSc) sobre GLMs\n\n```{r}\nFit1 <- glm(Measurement ~ bio1 + I(bio1^2) + bio7 + I(bio7^2) + bio12 + I(bio12^2) + bio15+ I(bio15^2), family = poisson , data = B_impatiens)\n```\n\n```{r, echo = FALSE}\nbroom::tidy(Fit1) %>%  kable() %>% kable_styling(bootstrap_options = c(\"striped\", \"hover\", \"condensed\")) %>%  scroll_box(width = \"100%\", height = \"400px\")\n```\n\n## Predecir en un raster\n\n```{r}\nPrediccion <- predict(Bioclim, Fit1, type = \"response\")\nplot(Prediccion, colNA = \"black\")\n```\n\n# Dudas?\n\n## Mapa con SF\n\n```{r}\nPrediccion_DF <- Prediccion %>% as(\"SpatialPixelsDataFrame\") %>% as.data.frame() %>% rename(Abundancia = layer)\n\nggplot() + geom_tile(data = Prediccion_DF, aes(x = x, y = y, fill = Abundancia)) + geom_sf(data = Mapa, alpha = 0) + theme_bw() + scale_fill_viridis_c() + xlab(\"\") + ylab(\"\")\n```\n\n## Mapa con los puntos\n\n```{r,eval=FALSE}\nggplot() + geom_tile(data = Prediccion_DF, aes(x = x, y = y, fill = Abundancia)) + geom_sf(data = Mapa, alpha = 0) + geom_sf(data = B_impatiens, aes(size = Measurement)) + theme_bw() + scale_fill_viridis_c(option = \"plasma\") + theme(legend.position = \"bottom\") + xlab(\"\") + ylab(\"\")\n```\n\n## Mapa con los puntos\n\n```{r, echo=FALSE}\nggplot() + geom_tile(data = Prediccion_DF, aes(x = x, y = y, fill = Abundancia)) + geom_sf(data = Mapa, alpha = 0) + geom_sf(data = B_impatiens, aes(size = Measurement)) + theme_bw() + scale_fill_viridis_c(option = \"plasma\")  + theme(legend.position = \"bottom\") + xlab(\"\") + ylab(\"\")\n```\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":{"ioslides_presentation":{"widescreen":true,"incremental":true}},"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css"],"toc":true,"output-file":"Clase8Modelos.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.335","theme":"cosmo","title":"Modelos con rasters","author":"Derek Corcoran","date":"`r format(Sys.time(), '%d/%m, %Y')`"},"extensions":{"book":{"multiFile":true}}}}}