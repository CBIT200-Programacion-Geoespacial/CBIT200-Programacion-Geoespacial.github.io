{
  "hash": "0ad27314a02c6e81dc2fc44ea5bc72f5",
  "result": {
    "markdown": "---\ntitle: \"Graficando mapas\"\nauthor: \"Derek Corcoran\"\ndate: \"08/08, 2023\"\noutput:\n  ioslides_presentation:\n    widescreen: true\n    incremental: true\n---\n\n\n\n\n## Objetivos de hoy\n\n-   Graficando Polígonos (y projecciones)\n    -   Escalas de colores\n-   Puntos\n    -   Nombres de lugares\n    -   Escalas diferentes\n    -   Separación de nombres\n-   Exportar gráficos en alta calidad\n    -   Que nos pide una revista\n-   Rasters\n    -   Variables categóricas\n    -   Cambiar las projecciones\n-   Inset maps\n\n## Cargamos paquetes\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(ggforce)\nlibrary(scales)\nlibrary(raster)\nlibrary(rworldxtra)\nlibrary(sf)\nlibrary(tidyverse)\n```\n:::\n\n\n# Polígonos\n\n## Partimos con un gráfico básico\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Base de datos\ngithubURL <- (\"https://raw.githubusercontent.com/derek-corcoran-barrios/derek-corcoran-barrios.github.io/master/Presentaciones_Espacial/Casos_Activos_Valpo.rds\")\n# La descargamos\ndownload.file(githubURL, \"Casos_Activos_Valpo.rds\")\n# La leemos\nCasos_Activos_Valpo <- readRDS(\"Casos_Activos_Valpo.rds\")\n# Gráfico simple\nggplot() + geom_sf(data = Casos_Activos_Valpo, aes(fill = Activos_por_100.000)) +\n    facet_wrap(~Fecha)\n```\n:::\n\n\n## Partimos con un gráfico básico (cont.)\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](Clase10_Mapas_files/figure-html/unnamed-chunk-3-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n## Modifiquemos la escala\n\n-   Experimentemos con el número de colores\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() + geom_sf(data = Casos_Activos_Valpo, aes(fill = Activos_por_100.000)) +\n    facet_wrap(~Fecha) + scale_fill_gradientn(name = \"Activos por 100.000 hab\",\n    colours = heat.colors(10))\n```\n:::\n\n\n## Modifiquemos la escala (cont)\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](Clase10_Mapas_files/figure-html/unnamed-chunk-5-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n## Otras paletas de colores\n\n-   rainbow\n-   terrain.colors\n-   topo.colors\n-   cm.colors\n\nEjemplo feo\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() + geom_sf(data = Casos_Activos_Valpo, aes(fill = Activos_por_100.000)) +\n    facet_wrap(~Fecha) + scale_fill_gradientn(name = \"Activos por 100.000 hab\",\n    colours = rainbow(10))\n```\n:::\n\n\n## Cuando es feo se nota por que es importante\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](Clase10_Mapas_files/figure-html/unnamed-chunk-7-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n## Viridis\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() + geom_sf(data = Casos_Activos_Valpo, aes(fill = Activos_por_100.000)) +\n    facet_wrap(~Fecha) + scale_fill_viridis_c(name = \"Activos por 100.000 hab\")\n```\n\n::: {.cell-output-display}\n![](Clase10_Mapas_files/figure-html/unnamed-chunk-8-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n## Escala por bins\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() + geom_sf(data = Casos_Activos_Valpo, aes(fill = Activos_por_100.000)) +\n    facet_wrap(~Fecha) + scale_fill_binned(name = \"Activos por 100.000 hab\")\n```\n\n::: {.cell-output-display}\n![](Clase10_Mapas_files/figure-html/unnamed-chunk-9-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n## Cambiando algunos default\n\n-   breaks: donde se cortan los bins\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() + geom_sf(data = Casos_Activos_Valpo, aes(fill = Activos_por_100.000)) +\n    facet_wrap(~Fecha) + scale_fill_binned(name = \"Activos por 100.000 hab\",\n    breaks = seq(0, 200, by = 25))\n```\n:::\n\n\n## Escala gradient2\n\n-   Algunos parametros importantes\n    -   mid = color de punto medio\n    -   high = color de valor alto\n    -   low = color de valor bajo\n    -   mipoint = que valor se considera medio\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() + geom_sf(data = Casos_Activos_Valpo, aes(fill = Activos_por_100.000)) +\n    facet_wrap(~Fecha) + scale_fill_gradient2(mid = \"white\",\n    low = muted(\"blue\"), high = muted(\"red\"), midpoint = median(Casos_Activos_Valpo$Activos_por_100.000),\n    name = \"Activos por 100.000 hab\")\n```\n:::\n\n\n## Escala gradient2\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](Clase10_Mapas_files/figure-html/unnamed-chunk-12-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n## últimos toques\n\n-   Punto de referencia del MINSAL 40 por cada 100.000 (midpoint)\n-   Agregamos titulo, subtitulo y fuente al pie\n-   Leyenda abajo\n-   lineas mas tenues\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() + geom_sf(data = Casos_Activos_Valpo, size = 0.05, aes(fill = Activos_por_100.000)) +\n    facet_wrap(~Fecha) + scale_fill_gradient2(mid = \"white\",\n    low = muted(\"blue\"), high = muted(\"red\"), midpoint = 40,\n    name = \"Activos por 100.000 hab\") + theme(legend.position = \"bottom\") +\n    labs(title = \"Prevalencia de Región de Valparaíso por Provincia\",\n        subtitle = paste(\"Actualizado\", max(CasosActivosCurso$Fecha)),\n        caption = \"Datos: https://github.com/MinCiencia/Datos-COVID19\",\n        y = NULL, x = NULL)\n```\n:::\n\n\n## Mapa final\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](Clase10_Mapas_files/figure-html/unnamed-chunk-14-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n# Puntos\n\n## Bajaremos puntos desde la biblioteca naciona\n\n-   Mapas [vectoriales de Chile](https://www.bcn.cl/siit/mapas_vectoriales/index_html)\n-   Ciudades y mas\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Bajamos el archivo\ndownload.file(\"https://www.bcn.cl/obtienearchivo?id=repositorio/10221/10400/2/Toponimos.zip\",\n    destfile = \"Topo.zip\")\n# Lo descomprimimos\nunzip(\"Topo.zip\")\n## Leemos el shapefile y nos quedamos solo con valparaíso\n## continenal\nTopo <- read_sf(\"Toponimos.shp\") %>%\n    dplyr::filter(Region == \"DE VALPARAISO\") %>%\n    st_crop(Casos_Activos_Valpo)\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output .cell-output-stdout}\n```\n[1] TRUE\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE\n```\n:::\n:::\n\n\n## Partamos con el mapa anterior de base:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nMapa <- ggplot() + geom_sf(data = Casos_Activos_Valpo, size = 0.05,\n    aes(fill = Activos_por_100.000)) + facet_wrap(~Fecha) + scale_fill_gradient2(mid = \"white\",\n    low = muted(\"blue\"), high = muted(\"red\"), midpoint = 40,\n    name = \"Activos por 100.000 hab\") + theme(legend.position = \"bottom\") +\n    labs(title = \"Prevalencia de Región de Valparaíso por Provincia\",\n        subtitle = paste(\"Actualizado\", max(Casos_Activos_Valpo$Fecha)),\n        caption = \"Datos: https://github.com/MinCiencia/Datos-COVID19\",\n        y = NULL, x = NULL)\n```\n:::\n\n\n## Agreguemos los puntos\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nMapa + geom_sf(data = Topo)\n```\n\n::: {.cell-output-display}\n![](Clase10_Mapas_files/figure-html/unnamed-chunk-18-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n## Quitemos puntos\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nTopo2 <- Topo %>%\n    dplyr::filter(Clase_Topo %in% c(\"Centro Poblado\"))\nTopo$Clase_Topo %>%\n    unique()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"Localidad Rural\"                     \n [2] \"Localidad o Area\"                    \n [3] \"Red Hidrografica\"                    \n [4] \"Elementos del Relieve\"               \n [5] \"Centro Poblado\"                      \n [6] \"Recinto Minero\"                      \n [7] \"Infraestructura Ferroviaria\"         \n [8] \"Comuna\"                              \n [9] \"Atributo Puntual\"                    \n[10] \"Entidades y Campamentos\"             \n[11] \"Termas y Baños\"                      \n[12] \"Calles. Carreteras, Caminos o Via Fe\"\n[13] \"Obras de Infraestructura\"            \n[14] \"Vegetacion\"                          \n```\n:::\n:::\n\n\n## Sigue siendo mucho\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nMapa + geom_sf(data = Topo2)\n```\n\n::: {.cell-output-display}\n![](Clase10_Mapas_files/figure-html/unnamed-chunk-20-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n## Dejemos solo las capitales provinciales\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nTopo2 <- Topo %>%\n    dplyr::filter(Nombre %in% c(\"Los Andes\", \"Quilpué\", \"La Ligua\",\n        \"Quillota\", \"San Antonio\", \"San Felipe\", \"Valparaíso\"),\n        Clase_Topo %in% c(\"Centro Poblado\"))\n```\n:::\n\n\n## Mejor!!\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nMapa + geom_sf(data = Topo2)\n```\n\n::: {.cell-output-display}\n![](Clase10_Mapas_files/figure-html/unnamed-chunk-22-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n## Agreguemos los nombres\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nMapa + geom_sf(data = Topo2) + geom_sf_text(data = Topo2, aes(label = Nombre))\n```\n\n::: {.cell-output-display}\n![](Clase10_Mapas_files/figure-html/unnamed-chunk-23-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n## Problemas\n\n-   Tapan los puntos y chocan los nombres\n-   ggrepel\n-   cambio de tema\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nMapa + geom_sf(data = Topo2) + ggrepel::geom_text_repel(data = Topo2,\n    aes(label = Nombre, geometry = geometry), stat = \"sf_coordinates\",\n    force = 1) + theme_bw()\n```\n:::\n\n\n## Listos?\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](Clase10_Mapas_files/figure-html/unnamed-chunk-25-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n# Exportando archivos\n\n## Usando tif\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntiff(\"Mapa.tiff\", units = \"in\", width = 10, height = 5, res = 600,\n    compression = \"lzw\")\nMapa + geom_sf(data = Topo2) + ggrepel::geom_text_repel(data = Topo2,\n    aes(label = Nombre, geometry = geometry), stat = \"sf_coordinates\",\n    force = 1) + theme_bw()\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\npng \n  2 \n```\n:::\n:::\n\n\n-   Se puede usar bmp, jpeg, png, svg, cairo_pdf\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output .cell-output-stdout}\n```\n[1] TRUE\n```\n:::\n:::\n\n\n# Rasters\n\n## Prioridades de conservación en el neotrópico\n\n-   De este [paper](https://onlinelibrary.wiley.com/doi/full/10.1111/ecog.05166)\n-   De [acá](https://figshare.com/collections/Hannah_et_al_2020_Ecography/4868019) pueden bajarlo para otros continentes\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndownload.file(\"https://ndownloader.figshare.com/files/21843771\",\n    destfile = \"Priority.tiff\")\nPriority <- raster(\"Priority.tiff\")\nplot(Priority, colNA = \"black\")\n```\n\n::: {.cell-output-display}\n![](Clase10_Mapas_files/figure-html/unnamed-chunk-28-1.png){fig-align='center' width=672}\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nPriority <- readAll(Priority)\nfile.remove(\"Priority.tiff\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] TRUE\n```\n:::\n:::\n\n\n## Polígono para el mismo lugar\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndata(\"countriesHigh\")\nSA <- countriesHigh %>%\n    st_as_sf() %>%\n    st_make_valid() %>%\n    st_crop(extent(Priority))\nggplot() + geom_sf(data = SA)\n```\n\n::: {.cell-output-display}\n![](Clase10_Mapas_files/figure-html/unnamed-chunk-30-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n## Cambiando Priority\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n## Cambiamos los NA a 0\nvalues(Priority) <- ifelse(is.na(values(Priority)), 0, values(Priority))\n## Generamos un raster de todo el neotropico con valores de\n## 1\nMASK <- rasterize(SA, Priority, field = 1)\n## Multiplicamos para dejar 0s e prioridad\nPriority <- Priority * MASK\n## Achicamos el extent\nPriority <- raster::trim(Priority)\n```\n:::\n\n\n## Transformamos las prioridades en categorías\n\n-   Valores de 1 es el 17%\n-   Valores de 0.87 son el 30%\n-   Valores de 0 son lugares muy desarrollados (Agricultura o ciudad)\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nPriority2 <- Priority %>%\n    as(\"SpatialPixelsDataFrame\") %>%\n    as.data.frame() %>%\n    rename(Priority = layer) %>%\n    mutate(Priority = case_when(Priority >= 0.97 ~ \"Prioridad muy alta\",\n        Priority < 1 & Priority > 0.87 ~ \"Prioridad alta\", Priority ==\n            0 ~ \"Altamente desarrollado\")) %>%\n    dplyr::filter(!is.na(Priority)) %>%\n    mutate(Priority = fct_relevel(Priority, \"Prioridad alta\",\n        \"Prioridad muy alta\"))\nP <- ggplot() + geom_sf(data = SA, size = 0.1) + geom_raster(data = Priority2,\n    aes(x = x, y = y, fill = Priority))\n```\n:::\n\n\n## Veamos que tal\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](Clase10_Mapas_files/figure-html/unnamed-chunk-33-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n## Mejoremos los colores\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nP <- P + scale_fill_manual(name = \"Priority\", values = c(\"#006d2c\",\n    \"#31a354\", \"#d7c29e\"))\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](Clase10_Mapas_files/figure-html/unnamed-chunk-35-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n## Avancemos más\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nP <- P + ylab(\"\") + xlab(\"\") + theme_bw()\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](Clase10_Mapas_files/figure-html/unnamed-chunk-37-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n## Inset map\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nP <- P + facet_zoom(xlim = c(-87.117, -82.56), ylim = c(5.51,\n    11.21), horizontal = T, zoom.size = 0.8, shrink = F)\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](Clase10_Mapas_files/figure-html/unnamed-chunk-39-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n## Exportamos\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntiff(\"Priority.tiff\", units = \"in\", width = 10, height = 8, res = 600,\n    compression = \"lzw\")\nP\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\npng \n  2 \n```\n:::\n:::\n",
    "supporting": [
      "Clase10_Mapas_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}